{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš´ì „ì ë³´í—˜ ì±—ë´‡</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <!-- ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ -->
    <div class="header">
        <form method="POST" action="{% url 'reset_chat' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit" class="reset-button">ëŒ€í™” ê¸°ë¡ ì´ˆê¸°í™”</button>
        </form>
        <form method="POST" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="logout-button">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
    </div>

    <div class="container">
        <h1>ğŸš˜ ìš´ì „ì ë³´í—˜ ì±—ë´‡</h1>

        <!-- ì‚¬ìš©ì ì•Œë¦¼ ì˜ì—­ -->
        <div id="message-box" class="message-box"></div>

        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="chat-box" id="chat-box">
            {% for chat in chat_history %}
                <div class="message-wrapper user-wrapper">
                    <div class="user-message">{{ chat.user }}</div>
                </div>
                <div class="message-wrapper bot-wrapper">
                    <div class="bot-message">{{ chat.bot }}</div>
                </div>
            {% endfor %}
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="input-section">
            <label for="upload-pdf" class="pdf-upload-button">ğŸ“„</label>
            <input type="file" id="upload-pdf" name="pdf_file" accept="application/pdf" style="display: none;">
            <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
            <button type="button" id="submit-question">ì „ì†¡</button>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì•Œë¦¼ -->
    <div id="success-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <p>âœ… íŒŒì¼ ì²˜ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
            <button onclick="closeModal()">í™•ì¸</button>
        </div>
    </div>

    <script>
        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            messageBox.innerHTML = `<p class="${type}-message">${message}</p>`;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('success-modal').style.display = 'none';
        }

        // PDF ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('upload-pdf').addEventListener('change', function() {
            const loadingIndicator = document.getElementById('message-box');
            if (this.files.length > 0) {
                const formData = new FormData();
                formData.append('pdf_file', this.files[0]);

                // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                showMessage('ğŸ”„ íŒŒì¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...', 'info');

                fetch("{% url 'upload_pdf' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'PDF ì—…ë¡œë“œ ì‹¤íŒ¨'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('success-modal').style.display = 'block'; // ëª¨ë‹¬ í‘œì‹œ
                    } else {
                        showMessage(data.message || 'PDF ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
                    }
                })
                .catch(error => {
                    showMessage('PDF ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
                });
            }
        });

        // ì§ˆë¬¸ ì œì¶œ ì²˜ë¦¬
        document.getElementById('submit-question').addEventListener('click', function () {
            const userInput = document.getElementById('user-input').value.trim();
            const chatBox = document.getElementById('chat-box');

            if (userInput) {
                // ì‚¬ìš©ì ì§ˆë¬¸ ì¶”ê°€
                const userMessage = `
                    <div class="message-wrapper user-wrapper">
                        <div class="user-message">
                            ${userInput}
                        </div>
                    </div>`;
                chatBox.innerHTML += userMessage;

                // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
                const loadingMessageId = `loading-${Date.now()}`;
                const loadingMessage = `
                    <div class="message-wrapper bot-wrapper">
                        <div class="bot-message" id="${loadingMessageId}">
                            ë¡œë”© ì¤‘...
                        </div>
                    </div>`;
                chatBox.innerHTML += loadingMessage;

                // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
                chatBox.scrollTop = chatBox.scrollHeight;

                // ì„œë²„ ìš”ì²­
                fetch("{% url 'chat' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_input: userInput })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'ì§ˆë¬¸ ì²˜ë¦¬ ì‹¤íŒ¨'); });
                    }
                    return response.json();
                })
                .then(data => {
                    // ë¡œë”© ë©”ì‹œì§€ë¥¼ ì‹¤ì œ ì‘ë‹µìœ¼ë¡œ êµì²´
                    const botMessage = `
                        <div class="message-wrapper bot-wrapper">
                            <div class="bot-message">
                                ${data.response}
                            </div>
                        </div>`;
                    const loadingElement = document.getElementById(loadingMessageId);
                    if (loadingElement) {
                        loadingElement.outerHTML = botMessage;
                    }
                })
                .catch(error => {
                    const errorMessage = `
                        <div class="message-wrapper bot-wrapper">
                            <div class="bot-message error-message">
                                ì˜¤ë¥˜ ë°œìƒ: ${error.message}
                            </div>
                        </div>`;
                    const loadingElement = document.getElementById(loadingMessageId);
                    if (loadingElement) {
                        loadingElement.outerHTML = errorMessage;
                    }
                });

                document.getElementById('user-input').value = '';
            } else {
                showMessage('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!', 'error');
            }
        });
    </script>
</body>
</html>
